#--
# Copyright (c) 2011- t1732 (https://github.com/t1732)
#
require 'open-uri'
require 'nkf'

class UrlTitleBot < Nadoka::NDK_Bot

  def bot_initialize
    @available_channel = @bot_config[:ch] || /.*/
    @user_agent = "Mozilla/5.0 (Macintosh; U; Intel Mac OS X 10_6_3; en-US) AppleWebKit/533.4 (KHTML, like Gecko) Chrome/5.0.375.55 Safari/533.4"
  end

  def on_privmsg(prefix, ch, msg)
    return unless @available_channel === ch
#    @logger.slog "current channel: #{ch}"

    if msg.gsub("ã€€", " ") =~ %r/(http|https)(:\/\/\S*).*(?!(jpg|jpeg|gif|png|bmp|swf))/
      url = "#{$1}#{$2}"
      html = open(url, {"User-Agent" => @user_agent}).read
      html.gsub!(%r/(\r\n|\r|\n)/, " ")

      nkf_option = '-j'
      if html =~ %r/charset=([a-zA-z_-]+)/
        nkf_option << add_option($1)
      end

      title = ""
      if html =~ %r/<title>(.*)<\/title>/
        title = $1
      end

      unless title.length.zero?
        converted_title = NKF.nkf(nkf_option, title)
        send_notice(ch, "  => #{converted_title}")
      end
    end
  end

  private

  def add_option(charset)
    case charset
    when 'ISO-2022-JP'
      ' -J'
    when 'EUC-JP', 'euc-jp'
      ' -E'
    when 'Shift_JIS', 'shift_jis'
      ' -S'
    when 'UTF-8', 'utf-8'
      ' -W'
    else
      ''
    end
  end

end
